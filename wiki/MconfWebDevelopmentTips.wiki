<wiki:toc max_depth="3" />

= Mconf-Web Development Tips =

== Sending emails in development ==

E-mails are sent by `delayed_job`, so you must run it's daemon:

{{{
rake jobs:clear                 # if you don't clear, all emails stored in the delayed_job table will be sent
script/delayed_job -n 2 start   # start 2 daemons
script/delayed_job stop         # to stop the daemons later
}}}

== Testing ==

Mconf-Web uses the [http://relishapp.com/rspec rspec framework] for automated tests.

=== Running the tests ===

To run the tests, first you need to set up your [MconfWebDevelopment development environment]. Then you can run the tests with:

{{{
bundle exec rake
}}}

This command will erase your entire test database, populate it with the seed data (see `db/seeds.rb`) and run *all* tests. It might take some time, but it runs the complete suite of tests to assure that everything is working properly.

Alternatively, you can set up the test database and run single tests to speed up the development.

Run the following command to set up a test database and populate it with the seed data:
{{{
RAILS_ENV=test bundle exec rake setup:db
}}}

Then run the tests using the `rspec` command. The first argument you need to pass to this command is the folder that contains the test files or the files you want to run. You can also specify a single line in a file to run a single test or a block of tests inside a scope. 

{{{
bundle exec rspec spec/                            # run all spec inside the folder spec/
bundle exec rspec spec/controllers/                # run all spec inside the folder spec/controllers/
bundle exec rspec spec/models/space_spec.rb        # run all specs in space_spec.rb
bundle exec rspec spec/models/space_spec.rb -l 40  # run the spec in the line 40 of space_spec.rb
}}}

Run `rspec --help` for more details.

It is important to run `rspec` with `bundle exec` so that the tests will run using the correct gem environment .

=== Testing migrations ===

We only test migrations that need to alter data in the DB. Simple migrations don't need to be tested.

We use `yaml_db` to get the server data and add it to the local database.
The test should apply the migration and test if the data was correctly migrated.

The server dump should be in the same version of your current database. The migration you're testing is a new migration, that wasn't applied in the server database yet.

{{{
RAILS_ENV=test bundle exec rake db:migrate                           # so that rails will recognize the new migration
cap production db:pull                                               # download the server dump (to db/data.yml)
RAILS_ENV=test bundle exec rake db:data:load                         # add it to the local test DB
bundle exec rspec spec/migration/MY_TEST_NAME.rb -t migration_real   # run the test
}}}

Also, tag your test with "migration_real":

{{{
context "using real data", :migration_real => true do
  ...
end
}}}


*Note*: Comment the following lines in your `spec_helper.rb` or your test will not run. We still have to find a better solution for this.

{{{
config.filter_run_excluding :migration => true
config.run_all_when_everything_filtered = true
}}}
