= XMMP server for Mconf-web =

<wiki:toc max_depth="3" />

We use the XMMP server [http://www.ejabberd.im/ ejabberd].

= Installation =

{{{
sudo apt-get install ejabberd python-mysqldb
}}}

Create a new database for ejabberd. Access MySQL monitor (`mysql -u root -p`) and:

### CRIAR USUARIO E LIMITAR ACESSO à TABELA USERS

{{{
CREATE USER 'mconf'@'localhost' IDENTIFIED BY 'password';
CREATE DATABASE mconf_ejabberd;
GRANT ALL PRIVILEGES ON mconf_ejabberd.* TO "mconf"@"localhost" IDENTIFIED BY "password";
FLUSH PRIVILEGES;
}}}

To start/stop it use:

{{{
sudo /etc/init.d/ejabberd start
sudo /etc/init.d/ejabberd stop
}}}


== Configurations ==
 
mod_admin_extra - Additional ejabberd commands
Used for VCard module

{{{
sudo wget https://raw.github.com/mconf/mconf-web/master/config/xmpp/mod_admin_extra.beam -o /usr/lib/ejabberd/ebin/mod_admin_extra.beam
sudo chown ejabberd:ejabberd /var/lib/ejabberd/JabberAuth.py
}}}



Open `/etc/ejabberd/ejabberd.cfg`.

{{{
%% Admin user
{acl, admin, {user, "admin", "$DOMAIN$"}}.
{acl, adminextraresource, {resource, "modadminextraf8x,31ad"}}.
{access, vcard_set, [
    {allow, adminextraresource},
    {deny, all}]
}.

%% Hostname
{hosts, ["$DOMAIN$"]}.

##############

%%
%% Modules enabled in all ejabberd virtual hosts.
%%
{modules,
 [
  {mod_http_bind, []},       #### INSERIR
  {mod_adhoc,    []}, 
  ...
  {mod_admin_extra, [ {module_resource, "modadminextraf8x,31ad"} ]},
  {mod_vcard,       [ {access_set, vcard_set} ]},
]}.

################

%% auth_method: Method used to authenticate the users.
%% The default method is the internal.
%% If you want to use a different method,
%% comment this line and enable the correct ones.
%%
%%{auth_method, internal}. ## COMENTAR

%%
%% Authentication using external script
%% Make sure the script is executable by ejabberd.
%%
{auth_method, external}.
{extauth_program, "python /var/lib/ejabberd/JabberAuth.py"}. 

}}}


Autenticação externa

{{{
sudo wget https://raw.github.com/mconf/mconf-web/master/config/xmpp/JabberAuth.py -o /var/lib/ejabberd/JabberAuth.py
sudo chown ejabberd:ejabberd /var/lib/ejabberd/JabberAuth.py
}}}


{{{

##########################################################
#DB Settings
#Just put your settings here.
##########################################################     
db_name="mconf_production"
db_user="mconf"
db_pass="my-password"
db_host="my-server.com"
db_table="users"
db_username_field="login"
db_password_field="crypted_password"
db_salt_field="salt"
domain_suffix="@my-server.com"
auth_url="http://my-server.com/xmpp/me"

}}}

...